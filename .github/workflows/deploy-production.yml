name: Deploy (Production)

on:
  workflow_dispatch: {}

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production (/)
    runs-on: ubuntu-latest
    environment: deploy

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PASS: ${{ secrets.SSH_PASS }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      REMOTE_ROOT: ${{ secrets.SSH_PATH }}
      SSH_OPTS: >-
        -o StrictHostKeyChecking=no
        -o HostKeyAlgorithms=+ssh-rsa
        -o PubkeyAcceptedAlgorithms=+ssh-rsa
        -o PreferredAuthentications=password,keyboard-interactive
        -o PubkeyAuthentication=no

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            roure/package-lock.json
            dashboard/package-lock.json

      - name: Install deps (roure)
        working-directory: roure
        run: npm ci

      - name: Build site (production, base-href=/)
        working-directory: roure
        run: npm run build -- --configuration=production --base-href=/

      - name: Ensure build output exists
        working-directory: roure
        run: test -d dist/rourepersonaltraining/browser

      - name: Add Apache SPA .htaccess into build output
        working-directory: roure
        run: cp src/.htaccess dist/rourepersonaltraining/browser/.htaccess

      - name: Create site deep-link fallbacks (no .htaccess required)
        working-directory: roure
        run: |
          set -euo pipefail
          ROOT="dist/rourepersonaltraining/browser"
          for p in about-us methods blog programs free-intake \
                   programs/weight-loss-muscle-mass programs/peak-performance programs/vitality-longevity programs/prenatal-postpartum; do
            mkdir -p "$ROOT/$p"
            cp "$ROOT/index.html" "$ROOT/$p/index.html"
          done

      - name: Install deps (dashboard)
        working-directory: dashboard
        run: npm ci

      - name: Build dashboard (production, base-href=/dashboard/)
        working-directory: dashboard
        run: npm run build -- --configuration=production

      - name: Ensure dashboard build output exists
        working-directory: dashboard
        run: test -f dist/dashboard/browser/index.html

      - name: Add Apache SPA .htaccess into dashboard build output
        working-directory: dashboard
        run: cp src/.htaccess dist/dashboard/browser/.htaccess

      - name: Create dashboard deep-link fallbacks (no .htaccess required)
        working-directory: dashboard
        run: |
          set -euo pipefail
          ROOT="dist/dashboard/browser"
          for p in login posts posts/new categories users users/new advanced/json; do
            mkdir -p "$ROOT/$p"
            cp "$ROOT/index.html" "$ROOT/$p/index.html"
          done

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Validate SSH secrets (fail fast if missing)
        shell: bash
        run: |
          set -euo pipefail
          test -n "${SSH_HOST:-}" || (echo "Missing SSH_HOST secret" && exit 1)
          test -n "${SSH_USER:-}" || (echo "Missing SSH_USER secret" && exit 1)
          test -n "${SSH_PASS:-}" || (echo "Missing SSH_PASS secret (is it set in Environment 'deploy'?)" && exit 1)
          test -n "${SSH_PORT:-}" || (echo "Missing SSH_PORT secret" && exit 1)
          test -n "${REMOTE_ROOT:-}" || (echo "Missing SSH_PATH secret (REMOTE_ROOT)" && exit 1)

      - name: Clean remote production web root (preserve /staging, /api data, /dashboard)
        run: >
          sshpass -p "$SSH_PASS" ssh
          -p "$SSH_PORT" $SSH_OPTS
          "$SSH_USER@$SSH_HOST"
          "cd '$REMOTE_ROOT' &&
           find . -mindepth 1 -maxdepth 1 ! -name 'staging' ! -name '.well-known' ! -name 'api' ! -name 'dashboard' -exec rm -rf {} + &&
           rm -rf '$REMOTE_ROOT/dashboard' &&
           mkdir -p '$REMOTE_ROOT/dashboard' '$REMOTE_ROOT/api' &&
           mkdir -p '$REMOTE_ROOT/../_private' '$REMOTE_ROOT/../images/uploads' &&
           mkdir -p '$REMOTE_ROOT/_private' '$REMOTE_ROOT/images/uploads'"

      - name: Upload site to production via SCP
        run: >
          sshpass -p "$SSH_PASS" scp
          -O
          -P "$SSH_PORT"
          $SSH_OPTS
          -r roure/dist/rourepersonaltraining/browser/*
          "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/"

      - name: Upload dashboard to production via SCP
        run: >
          sshpass -p "$SSH_PASS" scp
          -O
          -P "$SSH_PORT"
          $SSH_OPTS
          -r dashboard/dist/dashboard/browser/*
          "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/dashboard/"

      - name: Upload backend code to production API (preserve data)
        run: |
          set -euo pipefail
          # Upload code files
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/index.php "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/api/index.php"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/.htaccess "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/api/.htaccess"

          # Seed content/users only if missing.
          # We seed both locations:
          # - ../_private (preferred)
          # - ./_private inside public_html (fallback for open_basedir hosts)
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/content.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/../_private/content.seed.json"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/private/security/users.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/../_private/users.seed.json"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/content.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/_private/content.seed.json"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/private/security/users.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/_private/users.seed.json"

          sshpass -p "$SSH_PASS" ssh -p "$SSH_PORT" $SSH_OPTS "$SSH_USER@$SSH_HOST" "
            set -e;
            mkdir -p '$REMOTE_ROOT/../_private' '$REMOTE_ROOT/../images/uploads' '$REMOTE_ROOT/_private' '$REMOTE_ROOT/images/uploads';
            if [ ! -f '$REMOTE_ROOT/../_private/content.json' ]; then
              mv '$REMOTE_ROOT/../_private/content.seed.json' '$REMOTE_ROOT/../_private/content.json';
            else
              rm -f '$REMOTE_ROOT/../_private/content.seed.json';
            fi
            if [ ! -f '$REMOTE_ROOT/../_private/users.json' ]; then
              mv '$REMOTE_ROOT/../_private/users.seed.json' '$REMOTE_ROOT/../_private/users.json';
            else
              rm -f '$REMOTE_ROOT/../_private/users.seed.json';
            fi

            if [ ! -f '$REMOTE_ROOT/_private/content.json' ]; then
              mv '$REMOTE_ROOT/_private/content.seed.json' '$REMOTE_ROOT/_private/content.json';
            else
              rm -f '$REMOTE_ROOT/_private/content.seed.json';
            fi
            if [ ! -f '$REMOTE_ROOT/_private/users.json' ]; then
              mv '$REMOTE_ROOT/_private/users.seed.json' '$REMOTE_ROOT/_private/users.json';
            else
              rm -f '$REMOTE_ROOT/_private/users.seed.json';
            fi
          "

