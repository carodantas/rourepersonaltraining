name: Deploy (Staging)

on:
  push:
    branches: [main]

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Staging (/staging)
    runs-on: ubuntu-latest
    environment: deploy

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PASS: ${{ secrets.SSH_PASS }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      REMOTE_ROOT: ${{ secrets.SSH_PATH }}
      SSH_OPTS: >-
        -o StrictHostKeyChecking=no
        -o HostKeyAlgorithms=+ssh-rsa
        -o PubkeyAcceptedAlgorithms=+ssh-rsa
        -o PreferredAuthentications=password,keyboard-interactive
        -o PubkeyAuthentication=no

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            roure/package-lock.json
            dashboard/package-lock.json

      - name: Install deps (roure)
        working-directory: roure
        run: npm ci

      - name: Build site (staging, base-href=/staging/)
        working-directory: roure
        run: npm run build -- --configuration=staging --base-href=/staging/

      - name: Ensure build output exists
        working-directory: roure
        run: test -d dist/rourepersonaltraining/browser

      - name: Add Apache SPA .htaccess into build output
        working-directory: roure
        run: cp src/.htaccess dist/rourepersonaltraining/browser/.htaccess

      - name: Create site deep-link fallbacks (no .htaccess required)
        working-directory: roure
        run: |
          set -euo pipefail
          ROOT="dist/rourepersonaltraining/browser"
          for p in about-us methods blog programs free-intake \
                   programs/weight-loss-muscle-mass programs/peak-performance programs/vitality-longevity programs/prenatal-postpartum; do
            mkdir -p "$ROOT/$p"
            cp "$ROOT/index.html" "$ROOT/$p/index.html"
          done

      - name: Install deps (dashboard)
        working-directory: dashboard
        run: npm ci

      - name: Build dashboard (staging, base-href=/staging/dashboard/)
        working-directory: dashboard
        run: npm run build -- --configuration=staging

      - name: Ensure dashboard build output exists
        working-directory: dashboard
        run: test -f dist/dashboard/browser/index.html

      - name: Add Apache SPA .htaccess into dashboard build output
        working-directory: dashboard
        run: cp src/.htaccess dist/dashboard/browser/.htaccess

      - name: Create dashboard deep-link fallbacks (no .htaccess required)
        working-directory: dashboard
        run: |
          set -euo pipefail
          ROOT="dist/dashboard/browser"
          for p in login posts posts/new categories users users/new advanced/json; do
            mkdir -p "$ROOT/$p"
            cp "$ROOT/index.html" "$ROOT/$p/index.html"
          done

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Validate SSH secrets (fail fast if missing)
        shell: bash
        run: |
          set -euo pipefail
          test -n "${SSH_HOST:-}" || (echo "Missing SSH_HOST secret" && exit 1)
          test -n "${SSH_USER:-}" || (echo "Missing SSH_USER secret" && exit 1)
          test -n "${SSH_PASS:-}" || (echo "Missing SSH_PASS secret (is it set in Environment 'deploy'?)" && exit 1)
          test -n "${SSH_PORT:-}" || (echo "Missing SSH_PORT secret" && exit 1)
          test -n "${REMOTE_ROOT:-}" || (echo "Missing SSH_PATH secret (REMOTE_ROOT)" && exit 1)

      - name: Prepare remote staging folders (preserve staging/api data)
        run: >
          sshpass -p "$SSH_PASS" ssh
          -p "$SSH_PORT" $SSH_OPTS
          "$SSH_USER@$SSH_HOST"
          "mkdir -p '$REMOTE_ROOT/staging' '$REMOTE_ROOT/staging/api' '$REMOTE_ROOT/staging/dashboard' &&
           rm -rf '$REMOTE_ROOT/staging/dashboard' &&
           find '$REMOTE_ROOT/staging' -mindepth 1 -maxdepth 1 ! -name 'api' -exec rm -rf {} + &&
           mkdir -p '$REMOTE_ROOT/staging/dashboard' &&
           mkdir -p '$REMOTE_ROOT/../_private' '$REMOTE_ROOT/../images/uploads-staging' &&
           mkdir -p '$REMOTE_ROOT/_private' '$REMOTE_ROOT/images/uploads-staging'"

      - name: Upload site to staging via SCP
        run: >
          sshpass -p "$SSH_PASS" scp
          -O
          -P "$SSH_PORT"
          $SSH_OPTS
          -r roure/dist/rourepersonaltraining/browser/*
          "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/staging/"

      - name: Upload dashboard to staging via SCP
        run: >
          sshpass -p "$SSH_PASS" scp
          -O
          -P "$SSH_PORT"
          $SSH_OPTS
          -r dashboard/dist/dashboard/browser/*
          "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/staging/dashboard/"

      - name: Upload backend code to staging API (preserve data)
        run: |
          set -euo pipefail
          # Upload code files
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/index.php "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/staging/api/index.php"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/.htaccess "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/staging/api/.htaccess"

          # Seed content/users only if missing (isolated staging data).
          # We seed both locations:
          # - ../_private (preferred)
          # - ./_private inside public_html (fallback for open_basedir hosts)
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/content.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/../_private/content-staging.seed.json"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/private/security/users.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/../_private/users-staging.seed.json"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/content.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/_private/content-staging.seed.json"
          sshpass -p "$SSH_PASS" scp -O -P "$SSH_PORT" $SSH_OPTS backend/private/security/users.json "$SSH_USER@$SSH_HOST:$REMOTE_ROOT/_private/users-staging.seed.json"

          sshpass -p "$SSH_PASS" ssh -p "$SSH_PORT" $SSH_OPTS "$SSH_USER@$SSH_HOST" "
            set -e;
            mkdir -p '$REMOTE_ROOT/../_private' '$REMOTE_ROOT/../images/uploads-staging' '$REMOTE_ROOT/_private' '$REMOTE_ROOT/images/uploads-staging';

            if [ ! -f '$REMOTE_ROOT/../_private/content-staging.json' ]; then
              mv '$REMOTE_ROOT/../_private/content-staging.seed.json' '$REMOTE_ROOT/../_private/content-staging.json';
            else
              rm -f '$REMOTE_ROOT/../_private/content-staging.seed.json';
            fi
            if [ ! -f '$REMOTE_ROOT/../_private/users-staging.json' ]; then
              mv '$REMOTE_ROOT/../_private/users-staging.seed.json' '$REMOTE_ROOT/../_private/users-staging.json';
            else
              rm -f '$REMOTE_ROOT/../_private/users-staging.seed.json';
            fi

            if [ ! -f '$REMOTE_ROOT/_private/content-staging.json' ]; then
              mv '$REMOTE_ROOT/_private/content-staging.seed.json' '$REMOTE_ROOT/_private/content-staging.json';
            else
              rm -f '$REMOTE_ROOT/_private/content-staging.seed.json';
            fi
            if [ ! -f '$REMOTE_ROOT/_private/users-staging.json' ]; then
              mv '$REMOTE_ROOT/_private/users-staging.seed.json' '$REMOTE_ROOT/_private/users-staging.json';
            else
              rm -f '$REMOTE_ROOT/_private/users-staging.seed.json';
            fi
          "
